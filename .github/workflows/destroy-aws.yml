name: Destroy FortiGate AWS Resources

on:
  workflow_dispatch:
    inputs:
      fortigate_version:
        description: 'FortiGate Version'
        required: true
        default: '7.6'
        type: choice
        options:
        - '6.2'
        - '6.4'
        - '7.0'
        - '7.2'
        - '7.4'
        - '7.6'
      deployment_type:
        description: 'Deployment Type'
        required: true
        default: 'single'
        type: choice
        options:
        - single
        - ha
        - ha-single-az
        - ha-existing-vpc
        - ha-endpoint
        - ha-3ports
        - loadbalancer
        - gwlb
        - gwlb-crossaz
        - gwlb-multitenant
        - gwlb-transit
        - gwlb-transit-multireg
        - transitgwy
        - transitgwyconnect
      aws_region:
        description: 'AWS Region'
        required: true
        default: 'us-east-1'
      s3_bucket:
        description: 'S3 Bucket for Terraform state (if used in deploy)'
        required: false
        type: string
      confirm_destroy:
        description: 'Type "DESTROY" to confirm deletion'
        required: true
        type: string

env:
  TF_VERSION: '1.5.0'
  WORKING_DIR: ./aws/${{ github.event.inputs.fortigate_version }}/${{ github.event.inputs.deployment_type }}

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      path_exists: ${{ steps.check.outputs.exists }}
      confirmed: ${{ steps.confirm.outputs.confirmed }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Check deployment path
      id: check
      run: |
        if [ "${{ github.event.inputs.deployment_type }}" = "transitgwy" ]; then
          WORKING_DIR="./aws/${{ github.event.inputs.fortigate_version }}/transitgwy/terraform"
        else
          WORKING_DIR="${{ env.WORKING_DIR }}"
        fi
        
        if [ -d "$WORKING_DIR" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Path $WORKING_DIR does not exist"
          exit 1
        fi
        
    - name: Confirm destroy
      id: confirm
      run: |
        if [ "${{ github.event.inputs.confirm_destroy }}" = "DESTROY" ]; then
          echo "confirmed=true" >> $GITHUB_OUTPUT
        else
          echo "confirmed=false" >> $GITHUB_OUTPUT
          echo "❌ Destroy not confirmed. You must type 'DESTROY' to proceed."
          exit 1
        fi

  destroy:
    needs: validate
    runs-on: ubuntu-latest
    if: needs.validate.outputs.path_exists == 'true' && needs.validate.outputs.confirmed == 'true'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ github.event.inputs.aws_region }}
        
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: Set working directory
      id: workdir
      run: |
        if [ "${{ github.event.inputs.deployment_type }}" = "transitgwy" ]; then
          echo "dir=./aws/${{ github.event.inputs.fortigate_version }}/transitgwy/terraform" >> $GITHUB_OUTPUT
        else
          echo "dir=${{ env.WORKING_DIR }}" >> $GITHUB_OUTPUT
        fi
        
    - name: Configure S3 backend
      if: github.event.inputs.s3_bucket != ''
      working-directory: ${{ steps.workdir.outputs.dir }}
      run: |
        STATE_KEY="${{ github.event.inputs.fortigate_version }}/${{ github.event.inputs.deployment_type }}/terraform.tfstate"
        cat > backend.tf << EOF
        terraform {
          backend "s3" {
            bucket = "${{ github.event.inputs.s3_bucket }}"
            key    = "$STATE_KEY"
            region = "${{ github.event.inputs.aws_region }}"
          }
        }
        EOF
        
    - name: Fix Ubuntu AMI if linux.tf exists
      working-directory: ${{ steps.workdir.outputs.dir }}
      run: |
        if [ -f "linux.tf" ]; then
          echo "Fixing Ubuntu AMI in linux.tf..."
          sed -i.bak 's/ubuntu-bionic-18.04/ubuntu-jammy-22.04/g' linux.tf
          echo "Ubuntu AMI updated to 22.04 LTS"
        fi
        
    - name: Create license files for destroy
      working-directory: ${{ steps.workdir.outputs.dir }}
      run: |
        echo "# License file for destroy - content not needed" > license.lic
        echo "# License file for destroy - content not needed" > license2.lic
        
    - name: Create terraform.tfvars for destroy
      working-directory: ${{ steps.workdir.outputs.dir }}
      run: |
        cat > terraform.tfvars << EOF
        access_key = "${{ secrets.AWS_ACCESS_KEY_ID }}"
        secret_key = "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
        region = "${{ github.event.inputs.aws_region }}"
        EOF
        
    - name: Terraform Init
      working-directory: ${{ steps.workdir.outputs.dir }}
      run: terraform init
      
    - name: Terraform Destroy
      working-directory: ${{ steps.workdir.outputs.dir }}
      run: terraform destroy -auto-approve -input=false
      
    - name: Cleanup Summary
      run: |
        echo "## Destroy Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **FortiGate Version:** ${{ github.event.inputs.fortigate_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Type:** ${{ github.event.inputs.deployment_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **AWS Region:** ${{ github.event.inputs.aws_region }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ✅ Resources destroyed successfully" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ github.event.inputs.s3_bucket }}" ]; then
          echo "- **Terraform State:** Removed from S3 bucket ${{ github.event.inputs.s3_bucket }}" >> $GITHUB_STEP_SUMMARY
        fi
