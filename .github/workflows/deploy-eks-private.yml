name: Deploy EKS Private Cluster

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: 'AWS Region'
        required: true
        default: 'us-east-1'
      customer_vpc_id:
        description: 'Customer VPC ID from gwlb-crossaz (optional if hardcoded)'
        required: false
        type: string
      customer_public_subnet_az1_id:
        description: 'Public Subnet AZ1 ID (optional if hardcoded)'
        required: false
        type: string
      customer_public_subnet_az2_id:
        description: 'Public Subnet AZ2 ID (optional if hardcoded)'
        required: false
        type: string
      customer_private_subnet_az1_id:
        description: 'Private Subnet AZ1 ID (optional if hardcoded)'
        required: false
        type: string
      customer_private_subnet_az2_id:
        description: 'Private Subnet AZ2 ID (optional if hardcoded)'
        required: false
        type: string
      cluster_name:
        description: 'EKS Cluster Name'
        required: true
        default: 'customer-eks-cluster'
      eks_admin_user:
        description: 'IAM username for EKS admin access (optional)'
        required: false
        type: string
      s3_bucket:
        description: 'S3 Bucket for Terraform state (optional)'
        required: false
        type: string

env:
  TF_VERSION: '1.5.0'
  WORKING_DIR: ./aws/7.6/gwlb-eks-private

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ github.event.inputs.aws_region }}
        
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform-version: ${{ env.TF_VERSION }}
        
    - name: Set AZ variables based on region
      id: az
      run: |
        case "${{ github.event.inputs.aws_region }}" in
          us-east-1)
            echo "az1=us-east-1a" >> $GITHUB_OUTPUT
            echo "az2=us-east-1b" >> $GITHUB_OUTPUT
            ;;
          us-west-2)
            echo "az1=us-west-2a" >> $GITHUB_OUTPUT
            echo "az2=us-west-2b" >> $GITHUB_OUTPUT
            ;;
          eu-west-1)
            echo "az1=eu-west-1a" >> $GITHUB_OUTPUT
            echo "az2=eu-west-1b" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "az1=${{ github.event.inputs.aws_region }}a" >> $GITHUB_OUTPUT
            echo "az2=${{ github.event.inputs.aws_region }}b" >> $GITHUB_OUTPUT
            ;;
        esac
        
    - name: Configure S3 backend
      if: github.event.inputs.s3_bucket != ''
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        STATE_KEY="7.6/gwlb-eks-private/terraform.tfstate"
        cat > backend.tf << EOF
        terraform {
          backend "s3" {
            bucket = "${{ github.event.inputs.s3_bucket }}"
            key    = "$STATE_KEY"
            region = "${{ github.event.inputs.aws_region }}"
          }
        }
        EOF
        
    - name: Create terraform.tfvars
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        cat > terraform.tfvars << EOF
        access_key = "${{ secrets.AWS_ACCESS_KEY_ID }}"
        secret_key = "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
        region = "${{ github.event.inputs.aws_region }}"
        az1 = "${{ steps.az.outputs.az1 }}"
        az2 = "${{ steps.az.outputs.az2 }}"
        cluster_name = "${{ github.event.inputs.cluster_name }}"
        customer_vpc_id = "vpc-009cd288bad3903dc"
        customer_public_subnet_az1_id = "subnet-02d5d12b41c0d846f"
        customer_public_subnet_az2_id = "subnet-05a64f746bb4fc811"
        customer_private_subnet_az1_id = "subnet-0b8b8b8b8b8b8b8b8"
        customer_private_subnet_az2_id = "subnet-06af0c59e9fd58e06"
        kubernetes_version = "1.29"
        node_instance_types = ["t3.medium"]
        desired_capacity = 2
        max_capacity = 4
        min_capacity = 1
        endpoint_public_access = false
        EOF
        
        # Add admin user if provided
        if [ -n "${{ github.event.inputs.eks_admin_user }}" ]; then
          echo 'eks_admin_users = ["${{ github.event.inputs.eks_admin_user }}"]' >> terraform.tfvars
        else
          echo 'eks_admin_users = []' >> terraform.tfvars
        fi
        
        # Override hardcoded values with inputs if provided
        if [ -n "${{ github.event.inputs.customer_vpc_id }}" ]; then
          sed -i 's/customer_vpc_id = "vpc-009cd288bad3903dc"/customer_vpc_id = "${{ github.event.inputs.customer_vpc_id }}"/' terraform.tfvars
        fi
        if [ -n "${{ github.event.inputs.customer_public_subnet_az1_id }}" ]; then
          sed -i 's/customer_public_subnet_az1_id = "subnet-02d5d12b41c0d846f"/customer_public_subnet_az1_id = "${{ github.event.inputs.customer_public_subnet_az1_id }}"/' terraform.tfvars
        fi
        if [ -n "${{ github.event.inputs.customer_public_subnet_az2_id }}" ]; then
          sed -i 's/customer_public_subnet_az2_id = "subnet-05a64f746bb4fc811"/customer_public_subnet_az2_id = "${{ github.event.inputs.customer_public_subnet_az2_id }}"/' terraform.tfvars
        fi
        if [ -n "${{ github.event.inputs.customer_private_subnet_az1_id }}" ]; then
          sed -i 's/customer_private_subnet_az1_id = "subnet-0b8b8b8b8b8b8b8b8"/customer_private_subnet_az1_id = "${{ github.event.inputs.customer_private_subnet_az1_id }}"/' terraform.tfvars
        fi
        if [ -n "${{ github.event.inputs.customer_private_subnet_az2_id }}" ]; then
          sed -i 's/customer_private_subnet_az2_id = "subnet-06af0c59e9fd58e06"/customer_private_subnet_az2_id = "${{ github.event.inputs.customer_private_subnet_az2_id }}"/' terraform.tfvars
        fi
        
    - name: Terraform Init
      working-directory: ${{ env.WORKING_DIR }}
      run: terraform init
      
    - name: Terraform Plan
      working-directory: ${{ env.WORKING_DIR }}
      run: terraform plan -input=false -out=tfplan
      
    - name: Terraform Apply
      working-directory: ${{ env.WORKING_DIR }}
      run: terraform apply -input=false tfplan
        
    - name: Get Terraform Outputs
      id: outputs
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        echo "Retrieving Terraform outputs..."
        terraform output -json > outputs.json || echo "{}" > outputs.json
        
    - name: Output Summary
      run: |
        echo "## EKS Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **AWS Region:** ${{ github.event.inputs.aws_region }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Customer VPC:** ${{ github.event.inputs.customer_vpc_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Cluster Name:** ${{ github.event.inputs.cluster_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Availability Zones:** ${{ steps.az.outputs.az1 }}, ${{ steps.az.outputs.az2 }}" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ github.event.inputs.s3_bucket }}" ]; then
          echo "- **Terraform State:** Stored in S3 bucket ${{ github.event.inputs.s3_bucket }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Terraform State:** Local (not persistent)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Status: âœ… SUCCESS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Configure kubectl: \`aws eks update-kubeconfig --region ${{ github.event.inputs.aws_region }} --name ${{ github.event.inputs.cluster_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "2. Verify access: \`kubectl get nodes\`" >> $GITHUB_STEP_SUMMARY
