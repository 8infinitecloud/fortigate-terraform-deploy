name: Deploy FortiGate to AWS

on:
  workflow_dispatch:
    inputs:
      fortigate_version:
        description: 'FortiGate Version'
        required: true
        default: '7.6'
        type: choice
        options:
        - '6.2'
        - '6.4'
        - '7.0'
        - '7.2'
        - '7.4'
        - '7.6'
      deployment_type:
        description: 'Deployment Type'
        required: true
        default: 'single'
        type: choice
        options:
        - single
        - ha
        - ha-single-az
        - ha-existing-vpc
        - ha-endpoint
        - ha-3ports
        - loadbalancer
        - gwlb
        - gwlb-crossaz
        - gwlb-multitenant
        - gwlb-transit
        - transitgwy
        - transitgwyconnect
      aws_region:
        description: 'AWS Region'
        required: true
        default: 'us-east-1'
      license_type:
        description: 'License Type'
        required: true
        default: 'payg'
        type: choice
        options:
        - payg
        - byol
      instance_type:
        description: 'EC2 Instance Type'
        required: true
        default: 'c5.xlarge'
        type: choice
        options:
        - c5.large
        - c5.xlarge
        - c5.2xlarge
        - c5.4xlarge
        - c6g.large
        - c6g.xlarge
        - c6g.2xlarge
      architecture:
        description: 'Instance Architecture'
        required: true
        default: 'x86'
        type: choice
        options:
        - x86
        - arm
      keypair_name:
        description: 'AWS SSH Key Pair Name'
        required: true
        type: string
      byol_license_1:
        description: 'BYOL License 1 (only for BYOL deployments)'
        required: false
        type: string
      byol_license_2:
        description: 'BYOL License 2 (only for HA BYOL deployments)'
        required: false
        type: string
      vpc_cidr:
        description: 'VPC CIDR Block'
        required: false
        default: '10.1.0.0/16'
        type: string
      admin_port:
        description: 'FortiGate Admin Port'
        required: false
        default: '8443'
        type: string
      environment:
        description: 'Environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod

env:
  TF_VERSION: '1.5.0'
  WORKING_DIR: ./aws/${{ github.event.inputs.fortigate_version }}/${{ github.event.inputs.deployment_type }}

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      path_exists: ${{ steps.check.outputs.exists }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Check if deployment path exists
      id: check
      run: |
        if [ -d "${{ env.WORKING_DIR }}" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "❌ Path ${{ env.WORKING_DIR }} does not exist"
          exit 1
        fi

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    if: needs.validate.outputs.path_exists == 'true'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ github.event.inputs.aws_region }}
        
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: Create license files
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        if [ "${{ github.event.inputs.license_type }}" = "payg" ]; then
          # Create empty license files for PAYG
          echo "# PAYG - No license required" > license.lic
          echo "# PAYG - No license required" > license2.lic
        else
          # Create license files with BYOL content
          if [ -n "${{ github.event.inputs.byol_license_1 }}" ]; then
            echo "${{ github.event.inputs.byol_license_1 }}" > license.lic
          else
            echo "# BYOL License 1 - Please provide license content" > license.lic
          fi
          
          if [ -n "${{ github.event.inputs.byol_license_2 }}" ]; then
            echo "${{ github.event.inputs.byol_license_2 }}" > license2.lic
          else
            echo "# BYOL License 2 - Please provide license content" > license2.lic
          fi
        fi
        
    - name: Create terraform.tfvars
      working-directory: ${{ env.WORKING_DIR }}
      run: |
        cat > terraform.tfvars << EOF
        access_key = "${{ secrets.AWS_ACCESS_KEY_ID }}"
        secret_key = "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
        region = "${{ github.event.inputs.aws_region }}"
        license_type = "${{ github.event.inputs.license_type }}"
        size = "${{ github.event.inputs.instance_type }}"
        arch = "${{ github.event.inputs.architecture }}"
        keyname = "${{ github.event.inputs.keypair_name }}"
        vpccidr = "${{ github.event.inputs.vpc_cidr }}"
        adminsport = "${{ github.event.inputs.admin_port }}"
        EOF
        
    - name: Terraform Init
      working-directory: ${{ env.WORKING_DIR }}
      run: terraform init
      
    - name: Terraform Plan
      working-directory: ${{ env.WORKING_DIR }}
      run: terraform plan -input=false
      
    - name: Terraform Apply
      working-directory: ${{ env.WORKING_DIR }}
      run: terraform apply -auto-approve -input=false
      
    - name: Output Summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **FortiGate Version:** ${{ github.event.inputs.fortigate_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Type:** ${{ github.event.inputs.deployment_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **AWS Region:** ${{ github.event.inputs.aws_region }}" >> $GITHUB_STEP_SUMMARY
        echo "- **License Type:** ${{ github.event.inputs.license_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Instance Type:** ${{ github.event.inputs.instance_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Architecture:** ${{ github.event.inputs.architecture }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Key Pair:** ${{ github.event.inputs.keypair_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **VPC CIDR:** ${{ github.event.inputs.vpc_cidr }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event.inputs.license_type }}" = "byol" ]; then
          echo "- **BYOL License 1:** ${{ github.event.inputs.byol_license_1 != '' && 'Provided' || 'Not provided' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **BYOL License 2:** ${{ github.event.inputs.byol_license_2 != '' && 'Provided' || 'Not provided' }}" >> $GITHUB_STEP_SUMMARY
        fi
